{% extends "base.html" %}

{% block title %}Smart Packing Assistant - SustainABag{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Page Header */
    .page-header {
        background: linear-gradient(to right, var(--primary-green), var(--dark-green));
        color: white;
        padding: 80px 20px 60px;
        text-align: center;
        margin-bottom: 40px;
    }
    
    .page-header h1 {
        font-size: 2.8rem;
        margin: 0 0 15px 0;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .page-header p {
        font-size: 1.2rem;
        max-width: 600px;
        margin: 0 auto;
        opacity: 0.9;
    }
    
    .container {
        max-width: 1100px;
        margin: 0 auto 40px;
        padding: 0 30px;
    }
    
    .packing-form {
        background: white;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        padding: 40px;
        margin-bottom: 40px;
    }
    
    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .form-group {
        flex: 1;
        min-width: 250px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark-green);
    }
    
    .form-group input, .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    
    .form-group input:focus, .form-group select:focus {
        border-color: var(--accent-green);
        outline: none;
        box-shadow: 0 0 0 2px rgba(56, 142, 60, 0.2);
    }
    
    .btn {
        display: inline-block;
        background: var(--primary-green);
        color: white;
        border: none;
        padding: 14px 30px;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }
    
    .btn:hover {
        background: var(--dark-green);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-block {
        display: block;
        width: 100%;
    }
    
    .btn-secondary {
        background: #f5f5f5;
        color: var(--text-dark);
    }
    
    .btn-secondary:hover {
        background: #e0e0e0;
    }
    
    .results-container {
        display: none;
        background: white;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        padding: 40px;
        margin-top: 30px;
    }
    
    .weather-section {
        margin-bottom: 30px;
    }
    
    .weather-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        color: var(--primary-green);
    }
    
    .weather-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .weather-card {
        background: var(--light-green);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }
    
    .weather-card h4 {
        margin-bottom: 10px;
        color: var(--dark-green);
    }
    
    .weather-icon {
        font-size: 2.5rem;
        margin: 10px 0;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .temp-range {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 5px 0;
    }
    
    .packing-section {
        margin-top: 40px;
    }
    
    .packing-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        color: var(--primary-green);
    }
    
    .packing-tips {
        background: #e8f5e9;
        border-left: 4px solid var(--accent-green);
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 0 8px 8px 0;
    }
    
    .packing-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
    }
    
    .category {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        padding: 20px;
        border-top: 4px solid var(--accent-green);
    }
    
    .category h3 {
        margin-top: 0;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        color: var(--dark-green);
    }
    
    .items-list {
        list-style: none;
    }
    
    .items-list li {
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
        display: flex;
        align-items: center;
    }
    
    .items-list li:last-child {
        border-bottom: none;
    }
    
    .items-list input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        accent-color: var(--accent-green);
    }
    
    .items-list label {
        flex: 1;
        cursor: pointer;
    }
    
    .print-section {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        display: none;
    }
    
    .loading-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-green);
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .packing-form, .results-container {
            padding: 25px;
        }
        
        .page-header {
            padding: 60px 20px 40px;
        }
        
        .page-header h1 {
            font-size: 2.2rem;
        }
        
        .weather-cards {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">
    <h1>Smart Packing Assistant</h1>
    <p>Travel light with real-time weather-based packing recommendations</p>
</header>

<div class="container">
    <div class="packing-form">
        <h2 style="color: var(--dark-green); margin-top: 0; margin-bottom: 25px;">
            Plan Your Perfect Packing List
        </h2>
        
        <form id="packingForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="destination">Destination City</label>
                    <select id="destination" required>
                        <option value="">Select a city</option>
                        <option value="London,GB">London, UK</option>
                        <option value="Paris,FR">Paris, France</option>
                        <option value="Berlin,DE">Berlin, Germany</option>
                        <option value="Rome,IT">Rome, Italy</option>
                        <option value="Madrid,ES">Madrid, Spain</option>
                        <option value="Amsterdam,NL">Amsterdam, Netherlands</option>
                        <option value="Brussels,BE">Brussels, Belgium</option>
                        <option value="Vienna,AT">Vienna, Austria</option>
                        <option value="Prague,CZ">Prague, Czech Republic</option>
                        <option value="Stockholm,SE">Stockholm, Sweden</option>
                        <option value="Oslo,NO">Oslo, Norway</option>
                        <option value="Copenhagen,DK">Copenhagen, Denmark</option>
                        <option value="Helsinki,FI">Helsinki, Finland</option>
                        <option value="Athens,GR">Athens, Greece</option>
                        <option value="Lisbon,PT">Lisbon, Portugal</option>
                        <option value="Dublin,IE">Dublin, Ireland</option>
                        <option value="Warsaw,PL">Warsaw, Poland</option>
                        <option value="Budapest,HU">Budapest, Hungary</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="travelDates">Travel Dates</label>
                    <input type="date" id="travelDates" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="tripDuration">Trip Duration (days)</label>
                    <input type="number" id="tripDuration" min="1" max="90" placeholder="e.g. 7" required>
                </div>
                
                <div class="form-group">
                    <label for="travelType">Type of Travel</label>
                    <select id="travelType" required>
                        <option value="">Select travel type</option>
                        <option value="business">Business</option>
                        <option value="vacation">Vacation</option>
                        <option value="adventure">Adventure</option>
                        <option value="beach">Beach Holiday</option>
                        <option value="city">City Break</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="travelers">Number of Travelers</label>
                    <input type="number" id="travelers" min="1" max="10" value="1" required>
                </div>
                
                <div class="form-group">
                    <label for="luggageType">Luggage Type</label>
                    <select id="luggageType" required>
                        <option value="">Select luggage type</option>
                        <option value="carry-on">Carry-on Only</option>
                        <option value="checked">Checked Baggage</option>
                        <option value="backpack">Backpack</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-block">
                <i class="fas fa-suitcase"></i> Generate Packing List
            </button>
        </form>
    </div>
    
    <div class="loading" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Getting weather data and creating your packing list...</p>
    </div>
    
    <div class="results-container" id="resultsContainer">
        <div class="weather-section">
            <div class="weather-header">
                <i class="fas fa-cloud-sun fa-2x"></i>
                <h2>Weather Forecast for <span id="destinationName">Paris</span></h2>
            </div>
            
            <div class="weather-cards" id="weatherCards">
                <!-- Weather cards will be generated here -->
            </div>
        </div>
        
        <div class="packing-section">
            <div class="packing-header">
                <i class="fas fa-list-check fa-2x"></i>
                <h2>Recommended Packing List</h2>
            </div>
            
            <div class="packing-tips">
                <p><strong>Packing Tips:</strong> Based on your <span id="tripTypeText">vacation</span> to <span id="destinationText">Paris</span> for <span id="durationText">7</span> days, we recommend packing versatile items that can be mixed and matched. Remember to travel light and consider donating unused items at our SustainABag locations!</p>
            </div>
            
            <div class="packing-list" id="packingList">
                <!-- Packing list will be generated here -->
            </div>
            
            <div class="print-section">
                <button class="btn" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Your Packing List
                </button>
                <button class="btn btn-secondary" id="saveListBtn">
                    <i class="fas fa-save"></i> Save to Profile
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
    <p>SustainABag &copy; 2023 | Travel Light, Give Back, Shop Sustainably</p>
    <p>Weather data provided by OpenWeatherMap</p>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Set default date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('travelDates').valueAsDate = tomorrow;
    
    // Weather condition icons mapping
    const weatherIcons = {
        '01d': 'fa-sun',          // clear sky (day)
        '01n': 'fa-moon',         // clear sky (night)
        '02d': 'fa-cloud-sun',    // few clouds (day)
        '02n': 'fa-cloud-moon',   // few clouds (night)
        '03d': 'fa-cloud',        // scattered clouds
        '03n': 'fa-cloud',
        '04d': 'fa-cloud',        // broken clouds
        '04n': 'fa-cloud',
        '09d': 'fa-cloud-rain',   // shower rain
        '09n': 'fa-cloud-rain',
        '10d': 'fa-cloud-sun-rain', // rain (day)
        '10n': 'fa-cloud-moon-rain',// rain (night)
        '11d': 'fa-bolt',         // thunderstorm
        '11n': 'fa-bolt',
        '13d': 'fa-snowflake',    // snow
        '13n': 'fa-snowflake',
        '50d': 'fa-smog',         // mist
        '50n': 'fa-smog'
    };
    
    // Get weather data from OpenWeatherMap API
    async function getWeatherData(city) {
        const apiKey = 'b6c054d08614ff93875438d428c90dfa'; // Replace with your actual API key
        const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${apiKey}&units=metric`;
        
        try {
            const response = await fetch(apiUrl);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching weather data:', error);
            return null;
        }
    }
    
    // Process weather data to get daily forecasts
    function processWeatherData(weatherData, tripDuration) {
        if (!weatherData || !weatherData.list) return [];
        
        const dailyForecasts = [];
        const uniqueDays = new Set();
        
        // Only get the first 5 days of forecast
        const maxDays = Math.min(5, tripDuration);
        
        for (const forecast of weatherData.list) {
            // Extract the date (without time)
            const date = new Date(forecast.dt * 1000);
            const dateString = date.toISOString().split('T')[0];
            
            // Skip if we already have this day or have enough days
            if (uniqueDays.has(dateString) || dailyForecasts.length >= maxDays) continue;
            
            // Find min/max temp for the day
            const dayForecasts = weatherData.list.filter(f => {
                const forecastDate = new Date(f.dt * 1000).toISOString().split('T')[0];
                return forecastDate === dateString;
            });
            
            const temps = dayForecasts.map(f => f.main.temp);
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            
            // Get the most common weather condition for the day
            const conditions = dayForecasts.map(f => f.weather[0].icon);
            const conditionCount = {};
            conditions.forEach(cond => {
                conditionCount[cond] = (conditionCount[cond] || 0) + 1;
            });
            const mostCommonCondition = Object.keys(conditionCount).reduce((a, b) => 
                conditionCount[a] > conditionCount[b] ? a : b
            );
            
            // Format date to "Mon, Oct 15"
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            
            dailyForecasts.push({
                day: `Day ${dailyForecasts.length + 1}`,
                date: formattedDate,
                min_temp: Math.round(minTemp),
                max_temp: Math.round(maxTemp),
                condition: mostCommonCondition,
                description: dayForecasts[0].weather[0].description
            });
            
            uniqueDays.add(dateString);
        }
        
        return dailyForecasts;
    }
    
    // Generate weather cards
    function generateWeatherCards(weatherForecast) {
        const container = document.getElementById('weatherCards');
        container.innerHTML = '';
        
        weatherForecast.forEach(day => {
            const card = document.createElement('div');
            card.className = 'weather-card';
            card.innerHTML = `
                <h4>${day.day}</h4>
                <div>${day.date}</div>
                <div class="weather-icon">
                    <i class="fas ${weatherIcons[day.condition] || 'fa-cloud'}"></i>
                </div>
                <div class="temp-range">
                    ${day.max_temp}°C / ${day.min_temp}°C
                </div>
                <div>${day.description.charAt(0).toUpperCase() + day.description.slice(1)}</div>
            `;
            container.appendChild(card);
        });
    }
    
    // Generate packing list based on trip details
    function generatePackingList(weatherForecast, tripDuration, travelType, luggageType) {
        const container = document.getElementById('packingList');
        container.innerHTML = '';
        
        // Determine weather conditions
        const hasRain = weatherForecast.some(day => day.condition.startsWith('10') || day.condition.startsWith('09'));
        const hasCold = weatherForecast.some(day => day.min_temp < 10);
        const hasHot = weatherForecast.some(day => day.max_temp > 25);
        
        // Packing list templates
        const packingLists = {
            essentials: [
                "Passport/ID",
                "Travel documents",
                "Wallet with local currency",
                "Credit/debit cards",
                "Travel insurance info",
                "Hotel reservation details",
                "Emergency contacts",
                "Prescription medications"
            ],
            clothing: [
                `T-shirts (${Math.min(7, tripDuration)})`,
                `Long-sleeve shirts (${Math.min(3, Math.ceil(tripDuration/3))})`,
                ...(hasCold ? ["Sweater or fleece", "Warm jacket"] : ["Light jacket"]),
                `Pants/jeans (${Math.min(4, Math.ceil(tripDuration/2))})`,
                ...(hasHot ? [`Shorts (${Math.min(3, Math.ceil(tripDuration/3))})`] : []),
                "Pajamas",
                `Underwear (${tripDuration + 1})`,
                `Socks (${tripDuration + 1})`,
                "Comfortable walking shoes",
                ...(travelType === 'business' ? ["Dress shoes"] : []),
                "Belt"
            ],
            accessories: [
                "Sunglasses",
                ...(hasHot ? ["Hat or cap"] : []),
                ...(hasCold ? ["Scarf", "Light gloves"] : []),
                "Watch",
                "Jewelry (minimal)",
                ...(hasRain ? ["Umbrella", "Waterproof jacket"] : [])
            ],
            toiletries: [
                "Toothbrush & toothpaste",
                "Shampoo & conditioner",
                "Soap or body wash",
                "Deodorant",
                "Razor & shaving cream",
                "Hairbrush/comb",
                "Hair styling products",
                "Moisturizer",
                "Sunscreen",
                "Lip balm",
                ...(travelType !== 'adventure' ? ["Makeup (if applicable)"] : []),
                "Nail clippers",
                "First-aid kit"
            ],
            electronics: [
                "Phone & charger",
                "Power bank",
                "Headphones",
                ...(travelType === 'vacation' || travelType === 'city' ? ["Camera & charger"] : []),
                "Travel adapter",
                ...(travelType === 'business' ? ["Laptop & charger"] : []),
                ...(luggageType === 'backpack' ? [] : ["E-reader (optional)"])
            ],
            misc: [
                "Reusable water bottle",
                "Snacks",
                ...(luggageType === 'backpack' ? [] : ["Travel pillow"]),
                "Eye mask",
                "Ear plugs",
                "Book or magazine",
                "Travel guide/map",
                "Reusable shopping bag"
            ]
        };
        
        // Special items based on travel type
        if (travelType === 'beach') {
            packingLists.clothing.push("Swimsuit", "Beach cover-up", "Flip flops");
            packingLists.accessories.push("Beach towel", "Sunglasses");
        } else if (travelType === 'adventure') {
            packingLists.clothing.push("Hiking pants", "Hiking boots", "Quick-dry shirt");
            packingLists.misc.push("Waterproof bag", "Compass", "Multi-tool");
        }
        
        // Generate the list
        for (const category in packingLists) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category';
            
            let categoryName;
            switch(category) {
                case 'essentials': categoryName = 'Travel Essentials'; break;
                case 'clothing': categoryName = 'Clothing'; break;
                case 'accessories': categoryName = 'Accessories'; break;
                case 'toiletries': categoryName = 'Toiletries'; break;
                case 'electronics': categoryName = 'Electronics'; break;
                case 'misc': categoryName = 'Miscellaneous'; break;
                default: categoryName = category;
            }
            
            categoryDiv.innerHTML = `<h3>${categoryName}</h3><ul class="items-list"></ul>`;
            const list = categoryDiv.querySelector('.items-list');
            
            packingLists[category].forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="checkbox" id="${item.replace(/\s+/g, '-')}">
                    <label for="${item.replace(/\s+/g, '-')}">${item}</label>
                `;
                list.appendChild(li);
            });
            
            container.appendChild(categoryDiv);
        }
    }
    
    // Form submission handler
    document.getElementById('packingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form values
        const destination = document.getElementById('destination').value;
        const destinationParts = destination.split(',');
        const destinationName = destinationParts[0];
        const tripDuration = parseInt(document.getElementById('tripDuration').value);
        const travelType = document.getElementById('travelType').value;
        const luggageType = document.getElementById('luggageType').value;
        
        // Update destination name in results
        document.getElementById('destinationName').textContent = destinationName;
        document.getElementById('destinationText').textContent = destinationName;
        document.getElementById('tripTypeText').textContent = travelType;
        document.getElementById('durationText').textContent = tripDuration;
        
        // Show loading indicator
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        
        try {
            // Get weather data
            const weatherData = await getWeatherData(destination);
            if (!weatherData) {
                throw new Error('Failed to get weather data');
            }
            
            // Process weather data
            const weatherForecast = processWeatherData(weatherData, tripDuration);
            
            // Generate weather cards
            generateWeatherCards(weatherForecast);
            
            // Generate packing list
            generatePackingList(weatherForecast, tripDuration, travelType, luggageType);
            
            // Show results
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            
            // Scroll to results
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loadingIndicator').style.display = 'none';
            alert('Could not retrieve weather data. Please try again later.');
        }
    });
    
    // Save list button
    document.getElementById('saveListBtn').addEventListener('click', function() {
        alert('Packing list saved to your profile!');
    });
</script>
{% endblock %}